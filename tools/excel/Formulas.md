# 公式和函数

数据计算。
使用公式是简单分析的第一步。

# 1 以`=`开头，表示单元格输入的是公式

# 2 公式有 5 种元素

**Example :公式\_运算符**

(1) 运算符  
 (2) 常量数值  
 (3) 括号  
 (4) 单元格的引用  
 (5) 函数  
 函数是预先编写的公式。

# 3 公式中的数据？

直接的数据：(2)  
 间接的数据：(4)/(5)

# 4 运算符

##（1）算术运算符

| 算术运算符 | DESC         |
| ---------- | ------------ |
| +          | -            |
| -          | 减法 或 负数 |
| `*`        | -            |
| /          | -            |
| %          | 百分比       |
| ^          | 求乘方       |

##（2) 比较运算符

| 比较运算符 | DESC |
| ---------- | ---- |
| =          | -    |
| >          | -    |
| > =        | -    |
| <          | -    |
| <=         | -    |

比较运算符的运算结果是布尔值 TRUE (对)或 FALSE (错)。  
比较运算也可以用于文本,按字母顺序比较。TBD

##（3）文本连接运算符 `&`
可以连接文本、数字和单元格。

##（4）引用运算符

| 引用运算符 | 范围       |
| ---------- | ---------- |
| :(冒号)    | 连接一片   |
| ,(逗号)    | 或（合并） |
| (空格)     | 与（交叉） |

##（5） 括号运算符
用于改变公式的计算顺序。

# 5 Excel 运算符的优先级

| 优先顺序（高->低） | 运算符              | 说明       |
| ------------------ | ------------------- | ---------- |
| 1                  | `:` 和 `, ` 和 空格 | 引用运算符 |
| 2                  | -                   | 算数运算符 |
| 3                  | %                   | 算数运算符 |
| 4                  | ^                   | 算数运算符 |
| 5                  | `*` 和 `/`          | 算数运算符 |
| 6                  | + 和 -              | 算数运算符 |
| 7                  | &                   | 文本运算符 |
| 8                  | =,>,`>=`,<,`<=`     | 比较运算符 |

# 6 复制公式

方法 1: 选择性粘贴  
 方法 2: 拖拽

# 7 删除公式

删除数据和公式：Delete 键  
 删除公式，保留公式的计算结果：选择性粘贴 -> 【粘贴数值】-> 值

# 8 使用单元格引用 - A1 样式

## 单元格引用 - A1 样式

**Example :公式\_单元格引用**

单元格的引用方式有 3 种：

### (1)相对引用

列字母+行数字。  
引用整行或整列，可省去列标或行号。  
Example :  
`A1`  
`1:1` - 整行，第 1 行。  
`A:A` - 整列，第 1 列。

### (2)绝对引用

使用`冻结符号,即$`，成为绝对引用.  
绝对引用的含义是保持不变。  
Example : `$A$1`

### (3)混合引用

混合引用是指相对引用和绝对引用同时存在于一个单元格的地址引用中。

有 2 种形式。

形式 1:绝对行和相对列  
 Example：`A$1`

形式 2:绝对列和相对行  
 Example：`$A1`

**F4】键快速切换四种引用方法。**

## 单元格引用 - R1C1 样式

相对引用的标识符号`[]`  
当录制宏时，Excel 使用 R1C1 样式录制命令。

| 引用类型              | A1 样式 | R1C1 样式  | 特性                               |
| --------------------- | ------- | ---------- | ---------------------------------- |
| 相对引用              | A1      | `R[*]C[*]` | 向右向下复制公式，会改变引用关系   |
| 混合引用-行绝列列相对 | `A$1`   | `R1C[*]`   | 向下复制公式，不会改变引用关系     |
| 混合引用-列绝列行相对 | `$A1`   | `R[*]C1`   | 向右复制公式，不会改变引用关系     |
| 绝对引用              | `$A$1`  | `R1C1`     | 向右向下复制公式，不会改变引用关系 |

# 9 使用公式的技巧

（1）在公式中输入空格（Space）和空行（Alt + Enter）键，公式更容易理解，不影响计算结果。  
（2）手动计算公式  
Excel 公默认是自动计算。  
一个工作表中有很多复杂的公式时，自动计算会非常耗时。把公式计算模式改为【手动计算】，可以控制计算时间。

改为手动计算：  
公式 -> 【计算】计算选项 -> 手动.  
**快捷键 F9**

手动重新计算所有打开的工作簿（包括数据表），并更新所有打开的图表工作表：  
公式 -> 【计算】 -> 开始计算。 **快捷键 F9**  
**快捷键 【Ctrl + Alt + F9】**：强制重新计算所有工作打开的工作簿。

手动重新计算活动的工作表，以及链接到此工作表的所有图表和图表工作表，不计算同一个工作簿中的其他工作表：  
公式 -> 【计算】 -> 计算工作表。 **快捷键 Shift + F9**

当设置公式为手动计算模式后，Excel 自动选中【保存工作簿前重新计算】。  
Excel 选项 ->【公式】计算选项 -> 选中/取消 【保存工作簿前重新计算】。  
若保存工作簿时需要很长时间，取消它，以缩短保存时间。

（3）设置不计算数据表  
数据表是一个单元格区域，用于显示公式中一个或两个单元格的更改对公式结果造成的影响。  
数据表是 Excel 的 3 种假设分析工具（数据表、方案、单变量求解）之一。  
默认，每当重新计算工作表时，无论数据是否更改，都会重新计算数据表。若工作表或数据很大，会降低计算速度。

为了加快速度，在每次更改值、公式或名称时，只重新计算数据表之外的所有相关公式。  
公式 -> 【计算】计算选项 -> 【除模拟运算表外，自动计算】

（4） 常规计算  
【开始】/右键菜单 -> 选择计算类型，求和、计数等。

# 10 链接公式

链接公式:包含对其他工作表或工作簿单元格的引用的公式

- 链接公式的引用结构，有 2 种：  
  (1）引用同一工作簿中其他工作表中的单元格  
  格式：`=工作表名称!单元格地址`

Example: =【Formulas_Example_1.xlsx】 - 【链接公式\_Sheet_Score】

```
=Score!A1:A8
=AVERAGE(Score!A1:A8)
```

（2）引用其他工作簿中的单元格
格式：`=[工作簿名称]工作表名称!单元格地址`  
若被引用的工作簿没有打开，则在工作簿名称前自动添加文件的路径。

Example: 【Formulas_Example_1.xlsx】 - 【链接公式\_OtherWorkBoot_Sheet1】

```
=[Formulas_Example_2.xlsx]Sheet1!$A$1:$A$5
// Formulas_Example_2.xlsx 处于未打开状态
='/Users/hades/Documents/project/YingVickyCao.github.io/tools/excel/[Formulas_Example_2.xlsx]Sheet1'!$A$1:$A$5

=COUNT([Formulas_Example_2.xlsx]Sheet1!$A$1:$A$5)
// Formulas_Example_2.xlsx 处于未打开状态
=COUNT('/Users/hades/Documents/project/YingVickyCao.github.io/tools/excel/[Formulas_Example_2.xlsx]Sheet1'!$A$1:$A$5)
```

- 强制公式更新  
  若没有源工作簿中数据更新，但链接公式并没有重新计算。可以使用 Excel 的强制刷新功能，来确保链接公式拥有源工作簿的最新数据。  
  数据 -> 【连接】编辑链接 -> 【编辑链接】对话框，选择【更新值】

- 修改链接源  
  当已经保存外部链接公式中存在错误的文件，或 链接的源文件已经不能用了，要修改链接源  
  数据 -> 【连接】编辑链接 -> 【编辑链接】对话框，选择【更改源】

- 启用自动更新链接  
  当打开含有链接公式的工作簿时，给出（安全警告：已经禁用数据连接）。要更新链接，要单击【启动内容】。

- 取消外部链接公式  
  数据 -> 【连接】编辑链接 -> 【编辑链接】对话框，选择【断开链接】

## 检查链接状态

数据 -> 【连接】编辑链接 -> 【编辑链接】对话框，选择【检查状态】。  
 对需要更新的数据进行更新，直到所有链接的状态变为【已更新】 。

【状态】栏的情况：  
（1）【已更新】  
（2）【正常】  
表示链接工作正常且处于最新状态，不用进行任何操作。  
（3）【未知】  
需要单击【检查状态】按钮来更新列表中所有链接的状态。  
（4）【不适用】  
表示链接使用 OLE 或动态数据交换（DDE）。Excel 不能查询这些链接类型的状态。  
（5）【错误：未找到源】  
需要单击【更新源】来重新选择适当的工作簿。  
（6）【错误：未找到工作表】  
表示源可能已经移动或重命名。需要重新选择适当的工作表。  
（7）【警告：值未更新】  
表示打开工作簿时没有更新链接。  
可单击【更新值】更新值。  
（8）【警告：源未重新计算】  
表示工作簿是手动计算状态。需要先调整为自动计算状态。  
（9）【警告：请打开源以更新值】  
表示只有打开源，才能更新链接。  
单击【打开源文件】打开源并进行更新。  
（10）【源为打开状态】  
表示源出于打开状态。若没有收到工作表错误，无需任何操作。  
（11）【错误：状态不定】  
说明 Excel 不能确定链接的状态。源可能不包含工作，或工作表可能不受支持的文件格式保存。  
可单击【更新值】更新值。

# 11 数组

Excel 支持三维以及多维数组的计算，但是 Excel 不支持显示三维数组。一般情况是一维和二维数组进行计算。
**Example : 【Formulas_Example_1.xlsx】- 数组公式**

## 数组的维度

- 一维数组

一行多列——一维横向数组/水平数组/列数组。  
方向：行/横向/水平  
尺寸：一行 N 列【1 \* N】

一列多行——一维纵向数组/垂直数组/行数组  
方向：列/纵向/垂直  
尺寸：一列 N 行【N \* 1】

- 二维数组

多行多列 - 二维数组/矩阵。  
方向：行和列/横向和纵向。  
存在一个矩形范围。

行列数组相等的矩阵，又叫【方阵】。

二维数组的尺寸：M 行 N 列【M \* N】

## 数组的存在形式

###（1）常量数组  
语法：

```
{}
,分割列
; 分割行
```

```
Example :
// =后: 一维横向常量数组
={"1","34","50"}

// =后:一维纵向常量数组
={1;"China";10}

//  =后:二维常量数组
 ={1,"ABC",3,"2021-8-15";	50,"China",TRUE,#N/A}
```

元素：数值、文本、日期、逻辑值(TRUE/FALSE)和错误值（N/A）。  
常量数组不依赖单元格区域，可直接参与公式运算。

###（2）单元格区域数组
单元格区域数组是特定情况下对一组连续的单元格区域进行引用，被 Excel 自动转换得到的数组。Excel 会自动在数组公式外面加`{}`，手动输入`{}`是无效的，Excel 会认为输入的是一个正文标签。

```
Example :
// 普通公式 - 单元格区域数组
=E27:E29+D25

等价于

// 数组公式
={E27:E29+D25}
```

数组公式输入完成后，按**快捷键【Ctrl + Shift + Enter】**， 表明该公式是一个数组公式，Excel 不会按常规的逻辑来处理公式，自动添加`{}`。

###（3）内存数组  
内存数组，只出现在内存中，不是最终呈现的结果。  
内存数组，是指某一公式中通过计算，在内存中临时返回多个结果值构成的数组。该公式的计算结果不会存储在单元格区域中。而作为一个整体直接嵌入其他公式中继续参与运算，该公式被称为内存数组公式。

###（4）命名数组
命名数组：使用命名的方式为常量数组、区域数组、内存数组定义了名称的数组。该名称可以在公式中作为数组来调用。

## 数组公式

数组公式是 Excel 公式中一种专门用于数组的公式类型。参数是数组参数。  
数组公式的定义：对一组或多组值执行多重计算，并返回一个或多个结果。  
数组公式的运算结果，可能是一个值，或一个一维数组，或一个二维数组。

- 规则

规则 1 ： 输入数组公式后，要选择与计算结果相同的单元格或区域来保存。  
范围太小，则看不到所有的运算结果；  
范围太大，则超出大单元格出现错误提示`N/A`.  
规则 2 ： 数组公式所涉及的区域是一个整体，只能作为一个整体来进行操作。例如：删除、清除。不能单独编辑、清除或移动单个单元格，也不能插入和删除其中的任何一个单元格。

- 输入数组公式  
  数组公式的数值内容放在 **{}** 中。  
  公式输入完成后， 按 **快捷键【Ctrl + Shift + Enter】**

- 移动数组公式？  
  选择性粘贴

- 编辑数组公式？  
  单击它的任意一个单元格，然后开始编辑。编辑后 按 **快捷键【Ctrl + Shift + Enter】** 来重新计算新的数据结果。

- 如何全选整个数组区域？  
  选中该区域任意一个单元格，然后按 **【Ctrl+/】**

- 如何删除整个数组区域？  
  方法 1 : 选择整个数组区域，按 Delete 键。  
  方法 2 ： 在编辑栏中删除数组公式，然后按快捷键【Ctrl + Shift + Enter】完成编辑。  
  方法 3 ： 开始 -> 【编辑】清除 -> 全部清除。

- 多重计算 VS 数组公式
  数组公式，可能执行多重运算，也可能执行单个运算。  
  单执行多重计算的，不一定是数组公式。

```
//  数组公式 - 单个运算
={A1}

//  数组公式 - 多重运算。输入后，按快捷键【Ctrl + Shift + Enter】
={E27:E29+D25}

//  普通公式 - 多重运算，但不是数组公式，虽然与数组公式的运算结果相同。输入后，按快捷键【Enter】
=E27:E29+D25
```

- 数组公式 vs 普通公式  
  数组公式：不灵活。但整个数组区域，只有一个公式，方便管理，方便阅读。  
  普通公式：灵活。但公式众多，不好管理，看着也很乱，不利于阅读。

# 12 名称

**Example : 【Formulas_Example_1.xlsx】- 名称**

定义名称：为引用的单元格、范围、值或公式，定义一个名称。　  
定义名称，实际上，是创建了一个命名的公式，这个公式不存放在单元格中。

- 好处：  
  可读；  
  计算寻址能精确更小的范围；  
  缩小公式；  
  一旦更新引用位置，所有使用这个名称的公式都会自动更新；  
  缩短公式长度；  
  简写公式的编写，且随时可以修改名称的定义，来实现大量计算公式快速修改。  
  更容易创建和维护宏。

- 规则  
  名称不能与单元格相同。例如：C/c/R/r

- 名称的适用范围：  
  工作簿级名称。默认。  
  工作表级名称。

工作表级名称，仅能作用该工作表中。  
如在工作簿中其他工作表中使用它，格式为 `工作表名称 + ! + 名称` 。

```
// Example：在其他工作表中引用Sheet2的名称-姓名
Sheet2!姓名
```

- 定义单元格名称
  公式 -> 【定义的名称】定义名称

- 使用名称
  公式 -> 使用名称

```
// Example : 使用 名称 - 存款
=SUM(存款)
```

- 查看名称的引用位置  
  公式 -> 名称管理器

- 选择名称引用的单元格区域  
  方法 1 : 【名称框】右侧的下拉按钮  
  方法 2: 开始 -> 【编辑】查找和选择 -> 转到

- 修改名称的定义内容  
  公式 -> 名称管理器 -> 编辑

- 删除名称  
  公式 -> 名称管理器 -> 删除  
  名称删除后，引用它的单元格会显示`#NAME?`错误。

# 13 审核公式

（1）显示公式  
默认：在公式编辑栏显示公式，单元格中显示了运算结果。

如何让单元格显示公式，而不是值？  
公式 -> 公式审核 -> 显示公式

（2）查看公式的求值过程：分布计算  
公式 -> 公式审核 -> 公式求值

（3）公式错误检查  
公式 -> 公式审核 -> 错误检查 -> 【错误检查】对话框，显示计算步骤 -> 打开【公式求值】对话框。-> 然后【错误检查】对话框,在编辑栏中编辑

（4）追踪单元格引用情况

查看某个单元格引用了哪些单元格？  
公式 -> 公式审核 -> 追踪引用单元格

查看某个单元格被哪些单元格引用？  
公式 -> 公式审核 -> 追踪从属单元格

隐藏追踪箭头？  
公式 -> 公式审核 -> 删除箭头。

（5）查看哪些单元格的值能引起某个单元格的公式数值的变化  
公式 -> 公式审核 -> 监视窗口

(6) 如何对多个单元格执行相同计算  
例如，数值变为 2 倍。  
空白单元格输入 2 -> 然后选择要变化的区域 -> 开始，选择性粘贴 -> 【选择性粘贴】对话框， 选择 运算-“乘”。

（7）快速指定单元格以标题为名。  
公式 -> 【定义的名称】-> 根据所选内容创建 -> 【以选定区域创建名称】对话框，选择“首行”。

（8）根据粘贴名称快速完成公式的输入  
公式 -> 【定义的名称】-> 用于公式

（9）取消名称的自动引用  
默认，在编辑栏和单元格，公式中自动以名称来代替单元格的地址。

如何取消自动应用名称？  
【Excel 选项】-> 高级 -> Lotus 兼容性设置，选择 Sheet，选中“转换 Lotus-2-3 表达式”和“转换 Lotus-2-3 公式”。
设置后，在编辑栏，公式还是显示使用的名称，但在单元格中显示的是单元格地址。

（10）隐藏编辑栏中的公式  
如何对其他人看不见公式，但能直接将公式的计算结果通过复制来粘贴为数字？通过隐藏公式。隐藏后，选择包含公式的单元格，编辑栏中不再显示出公式。  
Step 1 ：开始 -> 格式 -> 设置单元格格式 -> 【设置单元格格式】对话框 ->【保护】，选中“隐藏”。  
Step 2 ：开始 -> 格式 -> 保护工作表 -> 选中 “选择锁定的单元格”和“选择未锁定的单元格”。  
只有隐藏 + 保护，公式才会隐藏。  
保护工作表 对话框中，要设置取消保护的密码。
