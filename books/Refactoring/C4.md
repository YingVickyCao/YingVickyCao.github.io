# 第 4 章 构筑测试体系

想要进行重构，前提是有一个可靠的测试环境。  
编写优良的测试程序，可以极大地提高编程速度，即使不进行重构也一样如此。

## 4.1 自测试代码的价值

- 程序员时间消耗：编写代码占据很少一部分，大部分时间用来调试。
- 每个类都应该有一个测试函数，并以它来测试自己这个类。
- 确保所有测试都完全自动化，让它们检查自己的测试结果。
- 一套测试就是一个强大得 bug 探测器，能够大大地缩减查找 bug 所需要的时间。
- 撰写测试代码的最有用时机是在开始编程之前。当需要添加新特性得时候，先写测试代码。
- 频繁进行测试是极限编程【Beck,XP】的重要一环。极限编程者都是十分专注的测试者。
- **重构必须需要测试代码。**
- 建立一个单独类用于测试，并在一个框架中运行它，使测试工作更加轻松。

## 4.2 Junit 测试框架

- 通常使用`Junit`测试框架
- `Junit` 由 Erich Gamma 和 Kent Beck【Junit】开发的开源测试框架。任何包含测试代码的类（即测试用例）都必须集成测试框架所提供的 TestCase 类。这个框架运用了 Composite 模式【Gang of Four】，允许将测试代码聚集到测试套件（test suite））中。

![refactoring_1](https://yingvickycao.github.io/img/refactoring_junit.jpg)

- 准备好测试夹具，`setUp()` 创建 `tearDown()` 删除
- Tip 现在使用注解`@Before` 、`@After`、 `@BeforeClass`、 `@AfterClass`。
- **频繁地运行测试。每次编译请把测试也考虑进去--每天至少执行每个测试一次。**
- 编写测试代码时，往往一开始让它们失败，为了确保测试机制的确可行。
- Junit  
  捕捉失败(false)  
  捕捉异常(exception)

### 单元测试和功能测试

- 单元测试  
  Junit 的用途是单元测试。  
  编写单元测试得目的是为了提高程序员得生产率。至于让 QA 部分开心，那只是附带效果而已。  
  单换测试是高度局部化得东西，每个测试类都隶属于单一包。它能够测试其他包得接口，除此之外，它将假设其他包一切正常。  
  程序员编写。  
  重构时，程序员使用的是单元测试。
- 功能测试  
  功能测试用来保证软件能够正常运作。  
  功能测试从客户的角度保证质量，并不关心程序员得生产力。  
  喜欢寻找 bug 的独立团队编写，比如 QA。  
  黑盒测试。功能测试尽可能把整个系统当作一个黑箱。面对一个拥有 GUI 待测系统，它们通过 GUI 来操作整个系统。面对文件更新程序或数据库更新程序，功能测试只观察特定输入所导致的数据变化。
- **每当你收到 bug 报告，请先写一个单元测试来暴露 bug。**  
  如果需要缩小 bug 出没范围，或如果其他相关失败，就编写出更多的测试。  
  使用测试来盯住 bug，并确保单元测试不会有类似漏网之虫。  
  功能测试往往以其他工具辅助进行。

## 4.3 添加更多测试

```
编写未臻完善得测试并实际运行，好过对完美测试的无尽等待。
```

- 观察类该做得所有事情，然后针对任何一种功能的任何一种可能失败的情况，进行测试。  
  测试应该是一种风险驱动的行为，测试的目的是希望找出现在或未来可能出现得错误。
- 并不是测试所有的 public 方法。  
  不用测试单纯的 get 和 set 方法，因为它们太简单了，不大可能出错。  
  如果编写过多测试，结果往往测试量反而不够：测试需要做那么多工作，令我退避三舍。
- 测试你担心出错的部分，这样从测试工作中得到最大收益。

---

```
考虑可能出错的边界条件，把测试火力集中在那儿。
```

- 测试得一项重要技巧-"寻找边界条件"。  
  利用断言，知道测试成功或失败。

“寻找边界条件”也包括寻找特殊的、可能导致测试失败的情况。  
e.g., 文件相关的测试，空文件是不错的边界条件。

---

```
当事情被认为应该会出错时，别忘了检查是否抛出了预期的异常。
```

- 任何测试都不能证明一个程序没有 bug。但这不影响“测试可以提高编程速度”。
- 不用测试所有情况的一切组合  
  当测试数量达到一定程序之后，继续增加测试带来的效益会呈递减态势，而非持续递增。  
  如果试图编写太多测试，你也可能因为工作量太大而气馁，最后什么也写不成。  
  应该把测试集中在最可能出错的地方。
- 不要因为测试无法捕捉所有 BUG 就不写测试，因为测试的确可以捕捉绝大多数 BUG。
- 构建良好的 BUG 检测器并经常运行它，这对任何开发工作都将大有裨益，并且是重构的前提。
- 继承和多态会让测试变得比较困难。  
  不要试着测试所有可能组合。  
  尽量测试每一个类，这将大大减少各种组合造成的风险。

## Refs

- [txidol - 重构摘要 4\_构筑测试体系](http://blog.csdn.net/tanxiang21/article/details/27641427)
