# 第 14 章 重构工具

## 14.1 使用工具进行重构

重构 -> 调整代码 -> 整理系统设计。这对代码的可维护性、可复用性和可解性，都能带来深远的正面影响。  
自动化重构之后无需测试，因此即使编码与重构之间的差异、“更换帽子”的过程尽管仍然存在，但远不如以前那样明显了。

重构成本降低 -> 设计错误成本降低 -> 预先设计更少。  
预先设计是一项带有预测性质的工作，因为项目激活之时，需求往往还不明朗。由于设计时尚未编写代码，所以正确的设计模式是：尽量简化需求尚未明朗的那一部分代码。借助自动化重构工具，让设计更具可变性，因为修改设计部再需要付出那么高的代价了。只对当前完全了解的问题进行设计，不需要预测系统未来所有可能的修改，以后很方便地扩展设计方案以加入额外的灵活性。

自动化工具所支持的重构，也影响了测试。很多重构都可以自动进行，无需再做测试。但是测试步骤永远都不可能被完全忽略。经验显示：在自动化重构工具的协助下，每天所需要运行的测试数量，和在无自动化重构工具的环境中大致相当。但完成的重构数量则大大增加。

## 14.2 重构工具的技术标准

重构工具最重要的用途是让程序员可以不用重新测试，便能对代码进行重构。  
=> 加上 Diff 工具，更完美。

### 程序数据库

类似于 IDEA Index 功能。只要代码有变化，都能检测到。

### 解析树

绝大多数重构都必须对函数层面下的一部分系统，通常是对被修改程序元素的引用。  
例如，父类的函数名改变了，所有子类重写的函数名、被调用函数名随之改变。

### 准确性

由于工具实现的重构，必须合理保持程序原有行为。完全的行为保持是不可能达到的，重构总是会给程序带来一些细微改变。 通常微小差异不会对程序造成影响。但如果程序有严格的实时性要求，这一点点差异可能导致整个程序出错。  
=> 反射

绝对大部分程序来说，重构可以相当准确。只要可能破坏重构准确性的因素被识别出来，重构技术人员就可以避免在不适当时候进行重构，也可以避免对于重构工具无法修补的程序错误地进行手工修补。  
=> IDEA 重命名操作有时候出现范围扩大的情况。

## 14.3 重构工具的实用标准

重构工具的最重要要求是，和其他工具共同集成出重构过程。

### 速度

开发速度总是很重要。绝大多数重构都可以在极短时间内以极高的准确度完成。  
如果重构前的分析需要花费太长时间，怎么办？直接询问程序员你所需要的信息，把保证准确性的责任交给了程序员，于是分析过程可以进行得更快一些。  
=> 花费了很长时间，也不能十分清楚这段逻辑，同时又没有同伴协助，那么放弃重构。比较好的做法是，先重构已经清晰的简单部分，比如重命名，删除 unused 代码等。

### 撤销

反重构（对原重构的撤销）应该不影响程序的原本行为。  
若重构时，若引入了一个不易查找的错误，则撤销重构。

## 14.4 小结

重构的目的：  
降低发程序的复杂度、代码臃肿不堪、错误百出、不堪一击。
